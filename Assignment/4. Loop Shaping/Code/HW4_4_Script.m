%% 
A = [-0.3360 2.4650 -2.4650 2.4650 -2.4650 2.4650 -0.6163;
     -0.3270 1.0279 -0.7476 0.7476 -0.7476 0.7476 -0.1869;
     -0.2657 1.0628 -1.3431 1.6233 -1.6233 1.6233 -0.4058;
     -0.3954 1.5816 -1.5816 1.3014 -1.0211 1.0211 -0.2553;
     -0.2325 0.9302 -0.9302 0.9302 -1.2104 1.4906 -0.3727;
     -0.1666 0.6663 -0.6663 0.6663 -0.6663 0.3861 -0.0265;
     -0.1597 0.6386 -0.6386 0.6386 -0.6386 0.6386 -0.4399];
B = [33.1501; 29.2147; 49.7430; 55.4071; 43.2351; 22.8726; 24.9153];
C = [41.1585 -164.6342 164.6342 -164.6342 164.6342 -164.6342 41.1585];
D = 0;
G = ss(A,B,C,D);
bode(G), grid

Integ = tf(1,[1 0]);
bw = 50*2*pi;  % 50 Hz in rad/s
PI = pidtune(G*Integ,'pi',50*2*pi);
C = PI*Integ;

bopt = bodeoptions; 
bopt.FreqUnits = 'Hz';  bopt.XLim = [1e0 1e4];
bodeplot(G*C,bopt), grid

[K,~,gam] = ncfsyn(-G,C);
[Gm,Pm] = margin(G*K);
bodeplot(G*C,G*K,bopt), grid
legend('PI design','Glover-McFarlane')
%%
A = [ -2.2567e-02  -3.6617e+01  -1.8897e+01  -3.2090e+01   3.2509e+00  -7.6257e-01;
       9.2572e-05  -1.8997e+00   9.8312e-01  -7.2562e-04  -1.7080e-01  -4.9652e-03;
       1.2338e-02   1.1720e+01  -2.6316e+00   8.7582e-04  -3.1604e+01   2.2396e+01;
       0            0            1.0000e+00   0            0            0;
       0            0            0            0           -3.0000e+01   0;
       0            0            0            0            0           -3.0000e+01];
B = [0     0;
     0     0;
     0     0;
     0     0;
    30     0;
     0    30];
C = [0     1     0     0     0     0;
     0     0     0     1     0     0];
D = [0     0;
     0     0];

G = ss(A,B,C,D);
G.InputName = {'elevon','canard'};
G.OutputName = {'attack','attitude'};

sigma(G);
step(G);

Gd = tf(8,[1 0]);
sigma(Gd,{0.1 100})
grid on

[K0,CL0,gamma0,info0] = loopsyn(G,Gd);
gamma0

L0 = G*K0;              
sigma(L0,"b",Gd,"r--",{.1,100});
grid
legend("L0 (actual loop shape)","Gd (target loop shape)");

step(CL0,5)